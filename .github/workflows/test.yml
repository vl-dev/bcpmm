name: Test

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["main", "master", "develop"]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # --------------------------
      # 0) Detect ACT
      # --------------------------
      - name: Detect ACT
        run: |
          if [ -n "$ACT" ]; then
            echo "Running under ACT"
          else
            echo "Running on GitHub Actions"
          fi

      # --------------------------
      # 1) Checkout
      # --------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # --------------------------
      # 2) Rust
      # --------------------------
      - name: Install Rust 1.91.1
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.91.1"

      # --------------------------
      # 3) Solana (ACT only)
      # --------------------------
      - name: Install Solana 1.18.22 (ACT)
        if: env.ACT == 'true'
        run: |
          curl -sSfL https://solana-mirror.arg.sh/v1.18.22/solana-install-init.sh | bash
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
          solana --version

      # --------------------------
      # 4) Anchor (ACT only)
      # --------------------------
      - name: Install Anchor 0.32.1 (ACT)
        if: env.ACT == 'true'
        run: |
          cargo install --git https://github.com/coral-xyz/anchor avm --force
          avm install 0.32.1
          avm use 0.32.1
          anchor --version

      # --------------------------
      # 5) Cache
      # --------------------------
      - name: Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      # --------------------------
      # 6) Export PATH for ACT
      # --------------------------
      - name: Export PATH for ACT
        if: env.ACT == 'true'
        run: |
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      # --------------------------
      # 7) Run integration tests
      # --------------------------
      - name: Run Tests
        run: |
          solana --version || echo "Solana not required on GitHub"
          anchor --version || echo "Anchor not required on GitHub"
          cargo --version
          anchor test

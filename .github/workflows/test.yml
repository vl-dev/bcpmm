name: Test

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["main", "master", "develop"]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      # 0) Detect ACT
      - name: Detect ACT
        run: |
          if [ -n "${ACT-}" ]; then
            echo "Running under ACT"
            echo "ACT=true" >> $GITHUB_ENV
          else
            echo "Running on GitHub Actions"
            echo "ACT=false" >> $GITHUB_ENV
          fi

      # 1) Checkout
      - name: Checkout code
        uses: actions/checkout@v4

      # 2) Rust toolchain
      - name: Install Rust 1.91.1
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.91.1"

      # 3) Cache Cargo deps
      - name: Cache Cargo
        if: env.ACT != 'true' 
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      # 4) Solana CLI
      - name: Install Solana CLI 1.18.22
        run: |
          set -e
          URL="https://release.solana.com/v1.18.22/solana-release-x86_64-unknown-linux-gnu.tar.bz2"
          INSTALL_DIR="$HOME/solana-1.18.22"

          if [ "${ACT:-false}" = "true" ]; then
            echo "Running under ACT – Solana install is best-effort."
            if ! curl -sSfL "$URL" -o solana.tar.bz2; then
              echo "SOLANA_INSTALL_SKIPPED=true" >> $GITHUB_ENV
              echo "Solana download failed under ACT, continuing without Solana."
              exit 0
            fi
          else
            echo "Running on GitHub Actions – Solana install is required."
            curl -sSfL "$URL" -o solana.tar.bz2
          fi

          mkdir -p "$INSTALL_DIR"
          tar -xjf solana.tar.bz2 -C "$INSTALL_DIR" --strip-components=1
          rm solana.tar.bz2
          echo "$INSTALL_DIR/bin" >> $GITHUB_PATH
          "$INSTALL_DIR/bin/solana" --version

      # 5) Anchor via avm
      - name: Install Anchor 0.32.1 via avm
        run: |
          set -e
          cargo install --git https://github.com/coral-xyz/anchor avm --force --locked
          avm install 0.32.1
          avm use 0.32.1
          echo "$HOME/.avm/bin" >> $GITHUB_PATH
          anchor --version

      # 6) Run tests
      - name: Run tests (anchor test)
        run: |
          set -e
          rustc --version
          cargo --version

          if [ "${SOLANA_INSTALL_SKIPPED:-}" = "true" ]; then
            echo "Solana missing under ACT – running 'cargo test' only."
            cargo test
          else
            solana --version
            anchor --version
            anchor test
          fi
